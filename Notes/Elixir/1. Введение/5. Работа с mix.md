Mix — это интегрированный инструмент управления проектами и сборки в языке программирования Elixir, предназначенный для автоматизации задач, связанных с созданием, компиляцией, тестированием, управлением зависимостями и развертыванием приложений. Mix играет центральную роль в экосистеме Elixir, облегчая разработку, структурирование и поддержку кода.

Mix напрямую позволяет создавать проекты, структуру можно изучить в главе [[6. Структура проекта Elixir]].

## Основные задачи и возможности mix

- Генерация новых проектов и структурирование кода.
- Управление зависимостями с использованием системы пакетов Hex.
- Организация, запуск и автоматизация скриптов и задач.
- Компиляция исходного кода Elixir и интеграция с компилятором Erlang.
- Запуск тестов и покрытие кода.
- Сборка, релиз и управление окружениями.

## Создание проектов с помощью mix

Mix предоставляет команду `mix new` для создания шаблонов новых проектов. Команда инициирует структуру проекта, автоматически формирует директории, файлы и базовые конфигурации.

### Базовый синтаксис команды

```bash
mix new <имя_проекта> [опции]
```

### Структура проекта, созданного с помощью mix

- `mix.exs` — основной файл конфигурации mix-проекта, содержащий сведения о проекте, его зависимостях, версиях и настройках компиляции.
- `lib/` — директория для размещения исходного кода приложения.
- `test/` — директория для тестовых файлов.
- `config/` — папка для конфигурационных файлов.
- `.formatter.exs` — опциональный файл конфигурации форматирования кода.

### Примеры опций команды `mix new`

- `--module` — задаёт имя главного модуля приложения.
- `--sup` — создаёт шаблон с поддержкой супервизора (OTP Application).

После создания проекта основной файл `mix.exs` содержит описание проекта, зависимости, настройки компиляции и другие параметры.

## Структура и содержание файла `mix.exs`

`mix.exs` является центральной точкой управления проектом. Обычно он содержит функцию `project/0`, функцию `application/0` (для OTP-приложений) и функцию `deps/0` для описания зависимостей.

```erlang
defmodule ProjectName.MixProject do
  use Mix.Project

  def project do
    [
      app: :project_name,
      version: "0.1.0",
      elixir: "~> 1.15",
      start_permanent: Mix.env() == :prod,
      deps: deps()
    ]
  end

  def application do
    [
      extra_applications: [:logger]
    ]
  end

  defp deps do
    [
      # {:имя_библиотеки, "~> версия"}
    ]
  end
end
```
## Работа со скриптами и задачами mix

Mix предоставляет встроенные задачи (tasks), которые можно использовать для автоматизации различных аспектов разработки. Встроенные задачи включают компиляцию, запуск интерактивной оболочки, тестирование, создание документации и другие функции.

### Примеры встроенных задач mix

- `mix compile` — компилирует исходный код проекта.
- `mix test` — запускает тесты, находящиеся в директории `test/`.
- `mix run` — выполняет указанный скрипт или функцию внутри проекта.
- `mix format` — форматирует исходный код в соответствии с настройками.
- `mix deps.get` — скачивает и устанавливает зависимости, указанные в `mix.exs`.
- `mix help` — отображает список доступных задач и справочную информацию по ним.

### Создание пользовательских задач

Mix позволяет определять собственные задачи (custom tasks), которые размещаются в директории `lib/mix/tasks/` и реализуются как модули Elixir с использованием `Mix.Task`.

```ruby

defmodule Mix.Tasks.Hello do
  use Mix.Task

  @shortdoc "Пример пользовательской задачи"

  def run(_args) do
    IO.puts "Hello from custom Mix task!"
  end
end
```
Пользовательская задача запускается с помощью `mix hello`.

## Управление зависимостями

Mix интегрируется с системой управления пакетами Hex, что позволяет подключать сторонние библиотеки (dependencies) к проекту.

### Описание зависимостей в `mix.exs`

Зависимости указываются в функции `deps/0` в виде списка кортежей:

```lua

defp deps do
  [
    {:имя_библиотеки, "~> версия"}
  ]
end
```

- `{:имя_библиотеки, "~> версия"}` — подключение зависимости с определённым требованием к версии.
- `{:имя_библиотеки, git: "url", tag: "тег"}` — подключение из репозитория Git по тэгу.
- `{:имя_библиотеки, path: "../путь"}` — подключение локальной зависимости.

После добавления новой зависимости необходимо выполнить команду `mix deps.get` для их загрузки и установки.

### Управление зависимостями

- `mix deps.get` — загрузка и установка всех зависимостей.
- `mix deps.update [имя]` — обновление всех или указанных зависимостей.
- `mix deps.clean [имя]` — удаление скомпилированных файлов зависимости.
- `mix deps.unlock [имя]` — разблокировка версии зависимости.

### Файлы зависимостей

- `mix.lock` — автоматически генерируемый файл, в котором фиксируются точные версии всех установленных зависимостей, обеспечивая повторяемость сборки.

## Механизм окружений (Environments) в mix

Mix поддерживает различные окружения (`:dev`, `:test`, `:prod`), которые определяют режим работы и настройки приложения. Окружение задаётся переменной окружения `MIX_ENV`.

- `dev` — используется для разработки, включает расширенные сообщения и автоматическую перезагрузку кода.
- `test` — предназначено для запуска тестов, имеет отдельные конфигурационные параметры.
- `prod` — оптимизировано для продуктивной эксплуатации, включает минимальный уровень логирования, компиляцию с флагом `start_permanent: true`.

Конфигурационные файлы для разных окружений размещаются в директории `config/` (например, `config/dev.exs`, `config/test.exs`, `config/prod.exs`).

## Практическое применение mix

- Быстрое создание и структурирование новых приложений.
- Организация повторяемого процесса сборки и тестирования.
- Управление внешними зависимостями и интеграция с экосистемой пакетов Hex.
- Адаптация приложений к различным окружениям разработки и эксплуатации.
- Автоматизация рутинных задач посредством пользовательских скриптов и задач.

## Принципы работы с mix

- Декларативность: все ключевые параметры проекта, зависимости и настройки описываются в `mix.exs`, что обеспечивает прозрачность и воспроизводимость сборки.
- Интеграция с OTP: mix поддерживает создание OTP-приложений и работу с супервизорами.
- Модульность: mix позволяет создавать umbrella-проекты, включающие несколько взаимосвязанных приложений.
- Расширяемость: посредством пользовательских задач и скриптов возможно расширение функциональности mix под нужды конкретного проекта.