Продолжим тему [[4.2 Maps и keyword lists]] с учетом главы [[1.2 Особенности]] языка и [[2.2 Структуры данных]], а точнее их иммутабельности.

В языке программирования Elixir структуры данных (structs) и отображения (maps) являются неизменяемыми (immutable). Это означает, что после создания структуры или отображения их содержимое не может быть изменено напрямую. Любые операции обновления приводят к созданию новой структуры или отображения с изменёнными значениями, при этом исходные данные остаются неизменными.

## Определение структур

Структура (struct) в Elixir представляет собой специальный тип отображения (map), который определяется с помощью модуля и директивы `defstruct`. Структуры позволяют создавать пользовательские типы данных с фиксированным набором ключей.

```ruby
defmodule User do
  defstruct name: "", age: 0
end

user = %User{name: "Алиса", age: 30}
```

## Неизменяемость структур и отображений

Любая попытка изменить существующую структуру или отображение приводит к созданию новой копии с изменёнными значениями. Это обеспечивает безопасность данных и предсказуемость поведения программ, особенно в многофункциональных и конкурентных системах.

## Синтаксис обновления структур и отображений

Для обновления значения одного или нескольких ключей в отображении или структуре применяется специальный синтаксис:

```ruby
%{map | key: new_value}
```

Где `map` — это исходное отображение или структура, `key` — имя ключа, а `new_value` — новое значение.

### Обновление отображения (map)

Для отображения можно использовать как этот синтаксис, так и функцию `Map.put/3` для обновления или добавления ключей:

```ruby
map = %{a: 1, b: 2}
new_map = %{map | a: 3}
# new_map => %{a: 3, b: 2}
```
При использовании синтаксиса `%{map | key: value}` обязательно, чтобы ключ уже существовал в исходном отображении, иначе будет сгенерировано исключение (`KeyError`). Для добавления новых ключей используется `Map.put/3`.

### Обновление структур (struct)

Структуры используют тот же синтаксис для обновления, однако допускается изменение только существующих ключей, определённых в `defstruct`. Попытка изменить несуществующий ключ вызовет ошибку (`KeyError`).

```ruby
user = %User{name: "Алиса", age: 30}
updated_user = %{user | age: 31}
# updated_user => %User{name: "Алиса", age: 31}
```
## Особенности обновления структур

- Обновление структур с помощью `%{struct | key: new_value}` создает новый экземпляр структуры с сохранением всех остальных полей.
- Обновление возможно только для ключей, определённых в `defstruct`; для других ключей будет выброшено исключение.
- Обновление структур не позволяет добавлять новые ключи или удалять существующие — только изменять значения уже определённых.
- Операция обновления сохраняет тип структуры и все метаданные.

## Сравнение с обновлением отображений

- Отображения позволяют обновлять только существующие ключи через `%{map | key: value}`; для добавления новых ключей используется `Map.put/3`.
- Структуры основаны на отображениях, но имеют ограниченный набор ключей и требуют соблюдения их перечня при обновлении.

## Практические применения

- Обновление значений в структурах данных без изменения оригинала, что важно в функциональном программировании.
- Безопасная передача данных между процессами и модулями, исключающая случайные побочные эффекты.
- Реализация неизменяемых коллекций для многопоточных и конкурентных вычислений.

## Ключевые принципы

1. Неизменяемость: все обновления возвращают новую структуру или отображение, исходные данные остаются неизменными.
2. Строгая типизация структур: обновлению подлежат только предопределённые ключи.
3. Безопасность: попытка обновить несуществующий ключ приводит к ошибке, предотвращая случайные опечатки и логические ошибки.

## Преимущества использования синтаксиса %{map | key: new_value}

- Явность и читаемость кода.
- Соответствие принципам функционального программирования.
- Гарантия безопасности типов и предсказуемости операций обновления.

## Примеры

```ruby
# Обновление отображения
map = %{a: 1, b: 2}
new_map = %{map | a: 5}

# Обновление структуры
defmodule Point do
  defstruct x: 0, y: 0
end

point = %Point{x: 10, y: 20}
new_point = %{point | y: 30}
```

## Ошибки при обновлении

- При попытке обновления несуществующего ключа возникает `KeyError`.
- Попытка добавить новый ключ с помощью `%{map | key: value}` приведёт к ошибке; для этого необходимо использовать функции работы с отображениями (`Map.put/3`).

## Заключение

Синтаксис `%{map | key: new_value}` является фундаментальным инструментом для безопасного и эффективного обновления неизменяемых структур данных в Elixir, обеспечивая строгий контроль за изменяемостью, целостностью и предсказуемостью данных.